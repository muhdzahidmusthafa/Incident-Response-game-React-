{"ast":null,"code":"import { __assign, __rest, __spreadArray } from \"tslib\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport React, { useCallback, useImperativeHandle, useLayoutEffect, useMemo, useRef } from 'react';\nimport clsx from 'clsx';\nimport { getBaseProps } from '../internal/base-component';\nimport { fireNonCancelableEvent } from '../internal/events';\nimport { useStableEventHandler } from '../internal/hooks/use-stable-event-handler';\nimport InternalAttributeEditor from '../attribute-editor/internal';\nimport InternalStatusIndicator from '../status-indicator/internal';\nimport InternalBox from '../box/internal';\nimport { FormFieldError } from '../form-field/internal';\nimport { TagControl, UndoButton } from './internal';\nimport { validate } from './validation';\nimport { findIndex, useMemoizedArray } from './utils';\nimport styles from './styles.css.js';\nimport { applyDisplayName } from '../internal/utils/apply-display-name';\nimport useBaseComponent from '../internal/hooks/use-base-component';\n\nvar isItemRemovable = function (_a) {\n  var tag = _a.tag;\n  return !tag.markedForRemoval;\n};\n\nvar TagEditor = React.forwardRef(function (_a, ref) {\n  var _b, _c;\n\n  var _d = _a.tags,\n      tags = _d === void 0 ? [] : _d,\n      i18nStrings = _a.i18nStrings,\n      _e = _a.loading,\n      loading = _e === void 0 ? false : _e,\n      _f = _a.tagLimit,\n      tagLimit = _f === void 0 ? 50 : _f,\n      allowedCharacterPattern = _a.allowedCharacterPattern,\n      keysRequest = _a.keysRequest,\n      valuesRequest = _a.valuesRequest,\n      onChange = _a.onChange,\n      restProps = __rest(_a, [\"tags\", \"i18nStrings\", \"loading\", \"tagLimit\", \"allowedCharacterPattern\", \"keysRequest\", \"valuesRequest\", \"onChange\"]);\n\n  var baseComponentProps = useBaseComponent('TagEditor');\n  var remainingTags = tagLimit - tags.filter(function (tag) {\n    return !tag.markedForRemoval;\n  }).length;\n  var attributeEditorRef = useRef(null);\n  var keyInputRefs = useRef([]);\n  var valueInputRefs = useRef([]);\n  var undoButtonRefs = useRef([]);\n  var initialKeyOptionsRef = useRef([]);\n  var keyDirtyStateRef = useRef([]);\n  var focusEventRef = useRef();\n  useLayoutEffect(function () {\n    var _a;\n\n    (_a = focusEventRef.current) === null || _a === void 0 ? void 0 : _a.apply(undefined);\n    focusEventRef.current = undefined;\n  });\n  var errors = validate(tags, keyDirtyStateRef.current, i18nStrings, allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined);\n  var internalTags = useMemoizedArray(tags.map(function (tag, i) {\n    return {\n      tag: tag,\n      error: errors[i]\n    };\n  }), function (prev, next) {\n    var _a, _b, _c, _d;\n\n    return prev.tag === next.tag && ((_a = prev.error) === null || _a === void 0 ? void 0 : _a.key) === ((_b = next.error) === null || _b === void 0 ? void 0 : _b.key) && ((_c = prev.error) === null || _c === void 0 ? void 0 : _c.value) === ((_d = next.error) === null || _d === void 0 ? void 0 : _d.value);\n  });\n  useImperativeHandle(ref, function () {\n    return {\n      focus: function () {\n        var _a, _b;\n\n        var errorIndex = findIndex(internalTags, function (_a) {\n          var error = _a.error;\n          return (error === null || error === void 0 ? void 0 : error.key) || (error === null || error === void 0 ? void 0 : error.value);\n        });\n\n        if (errorIndex !== -1) {\n          var refArray = ((_a = internalTags[errorIndex].error) === null || _a === void 0 ? void 0 : _a.key) ? keyInputRefs : valueInputRefs;\n          (_b = refArray.current[errorIndex]) === null || _b === void 0 ? void 0 : _b.focus();\n        }\n      }\n    };\n  }, [internalTags]);\n  var validateAndFire = useCallback(function (newTags) {\n    fireNonCancelableEvent(onChange, {\n      tags: newTags,\n      valid: !validate(newTags, keyDirtyStateRef.current, i18nStrings, allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined).some(function (error) {\n        return error;\n      })\n    });\n  }, [onChange, i18nStrings, allowedCharacterPattern]);\n\n  var onAddButtonClick = function () {\n    validateAndFire(__spreadArray(__spreadArray([], tags, true), [{\n      key: '',\n      value: '',\n      existing: false\n    }], false));\n\n    focusEventRef.current = function () {\n      var _a;\n\n      (_a = keyInputRefs.current[tags.length]) === null || _a === void 0 ? void 0 : _a.focus();\n    };\n  };\n\n  var onRemoveButtonClick = useStableEventHandler(function (_a) {\n    var _b;\n\n    var detail = _a.detail;\n    var existing = tags[detail.itemIndex].existing;\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, detail.itemIndex), true), existing ? [__assign(__assign({}, tags[detail.itemIndex]), {\n      markedForRemoval: true\n    })] : [], true), tags.slice(detail.itemIndex + 1), true));\n\n    if (existing) {\n      focusEventRef.current = function () {\n        var _a;\n\n        (_a = undoButtonRefs.current[detail.itemIndex]) === null || _a === void 0 ? void 0 : _a.focus();\n      };\n    } else {\n      keyDirtyStateRef.current.splice(detail.itemIndex, 1);\n      (_b = keyInputRefs.current[detail.itemIndex]) === null || _b === void 0 ? void 0 : _b.focus();\n    }\n  });\n  var onKeyChange = useStableEventHandler(function (value, row) {\n    keyDirtyStateRef.current[row] = true;\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      key: value\n    })], false), tags.slice(row + 1), true));\n  });\n  var onKeyBlur = useStableEventHandler(function (row) {\n    keyDirtyStateRef.current[row] = true; // Force re-render by providing a new array reference\n\n    validateAndFire(__spreadArray([], tags, true));\n  });\n  var onValueChange = useStableEventHandler(function (value, row) {\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      value: value\n    })], false), tags.slice(row + 1), true));\n  });\n  var onUndoRemoval = useStableEventHandler(function (row) {\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      markedForRemoval: false\n    })], false), tags.slice(row + 1), true));\n\n    focusEventRef.current = function () {\n      var _a;\n\n      (_a = attributeEditorRef.current) === null || _a === void 0 ? void 0 : _a.focusRemoveButton(row);\n    };\n  });\n  var definition = useMemo(function () {\n    return [{\n      label: i18nStrings.keyHeader,\n      control: function (_a, row) {\n        var tag = _a.tag;\n        return React.createElement(TagControl, {\n          row: row,\n          value: tag.key,\n          readOnly: tag.existing,\n          limit: 200,\n          defaultOptions: [],\n          placeholder: i18nStrings.keyPlaceholder,\n          errorText: i18nStrings.keysSuggestionError,\n          loadingText: i18nStrings.keysSuggestionLoading,\n          suggestionText: i18nStrings.keySuggestion,\n          tooManySuggestionText: i18nStrings.tooManyKeysSuggestion,\n          enteredTextLabel: i18nStrings.enteredKeyLabel,\n          onRequest: keysRequest,\n          onChange: onKeyChange,\n          onBlur: onKeyBlur,\n          initialOptionsRef: initialKeyOptionsRef,\n          ref: function (ref) {\n            keyInputRefs.current[row] = ref;\n          }\n        });\n      },\n      errorText: function (_a) {\n        var error = _a.error;\n        return error === null || error === void 0 ? void 0 : error.key;\n      }\n    }, {\n      label: React.createElement(React.Fragment, null, i18nStrings.valueHeader, \" - \", React.createElement(\"i\", null, i18nStrings.optional)),\n      control: function (_a, row) {\n        var _b;\n\n        var tag = _a.tag;\n        return tag.markedForRemoval ? React.createElement(\"div\", {\n          role: \"alert\"\n        }, React.createElement(InternalBox, {\n          margin: {\n            top: 'xxs'\n          }\n        }, i18nStrings.undoPrompt, ' ', React.createElement(UndoButton, {\n          onClick: function () {\n            return onUndoRemoval(row);\n          },\n          ref: function (elem) {\n            undoButtonRefs.current[row] = elem;\n          }\n        }, i18nStrings.undoButton))) : React.createElement(TagControl, {\n          row: row,\n          value: tag.value,\n          readOnly: false,\n          limit: 200,\n          defaultOptions: (_b = tag.valueSuggestionOptions) !== null && _b !== void 0 ? _b : [],\n          placeholder: i18nStrings.valuePlaceholder,\n          errorText: i18nStrings.valuesSuggestionError,\n          loadingText: i18nStrings.valuesSuggestionLoading,\n          suggestionText: i18nStrings.valueSuggestion,\n          tooManySuggestionText: i18nStrings.tooManyValuesSuggestion,\n          enteredTextLabel: i18nStrings.enteredValueLabel,\n          filteringKey: tag.key,\n          onRequest: valuesRequest && function (value) {\n            return valuesRequest(tag.key, value);\n          },\n          onChange: onValueChange,\n          ref: function (ref) {\n            valueInputRefs.current[row] = ref;\n          }\n        });\n      },\n      errorText: function (_a) {\n        var error = _a.error;\n        return error === null || error === void 0 ? void 0 : error.value;\n      }\n    }];\n  }, [i18nStrings, keysRequest, onKeyChange, onKeyBlur, valuesRequest, onValueChange, onUndoRemoval]);\n\n  if (loading) {\n    return React.createElement(\"div\", {\n      className: styles.root,\n      ref: baseComponentProps.__internalRootRef\n    }, React.createElement(InternalStatusIndicator, {\n      className: styles.loading,\n      type: \"loading\"\n    }, i18nStrings.loading));\n  }\n\n  var baseProps = getBaseProps(restProps);\n  return React.createElement(InternalAttributeEditor, __assign({}, baseProps, baseComponentProps, {\n    ref: attributeEditorRef,\n    className: clsx(styles.root, baseProps.className),\n    items: internalTags,\n    isItemRemovable: isItemRemovable,\n    onAddButtonClick: onAddButtonClick,\n    onRemoveButtonClick: onRemoveButtonClick,\n    addButtonText: i18nStrings.addButton,\n    removeButtonText: i18nStrings.removeButton,\n    disableAddButton: remainingTags <= 0,\n    empty: i18nStrings.emptyTags,\n    additionalInfo: React.createElement(\"div\", {\n      \"aria-live\": \"polite\"\n    }, remainingTags < 0 ? React.createElement(FormFieldError, null, (_b = i18nStrings.tagLimitExceeded(tagLimit)) !== null && _b !== void 0 ? _b : '') : remainingTags === 0 ? (_c = i18nStrings.tagLimitReached(tagLimit)) !== null && _c !== void 0 ? _c : '' : i18nStrings.tagLimit(remainingTags, tagLimit)),\n    definition: definition\n  }));\n});\napplyDisplayName(TagEditor, 'TagEditor');\nexport default TagEditor;","map":{"version":3,"mappings":"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","names":["React","useCallback","useImperativeHandle","useLayoutEffect","useMemo","useRef","clsx","getBaseProps","fireNonCancelableEvent","useStableEventHandler","InternalAttributeEditor","InternalStatusIndicator","InternalBox","FormFieldError","TagControl","UndoButton","validate","findIndex","useMemoizedArray","styles","applyDisplayName","useBaseComponent","isItemRemovable","_a","tag","markedForRemoval","TagEditor","forwardRef","ref","_d","i18nStrings","_e","loading","_f","tagLimit","allowedCharacterPattern","keysRequest","valuesRequest","onChange","restProps","baseComponentProps","remainingTags","tags","filter","length","attributeEditorRef","keyInputRefs","valueInputRefs","undoButtonRefs","initialKeyOptionsRef","keyDirtyStateRef","focusEventRef","current","apply","undefined","errors","RegExp","internalTags","map","i","error","prev","next","key","_b","_c","value","focus","errorIndex","refArray","validateAndFire","newTags","valid","some","onAddButtonClick","existing","onRemoveButtonClick","detail","itemIndex","slice","splice","onKeyChange","row","onKeyBlur","onValueChange","onUndoRemoval","focusRemoveButton","definition","label","keyHeader","control","readOnly","limit","defaultOptions","placeholder","keyPlaceholder","errorText","keysSuggestionError","loadingText","keysSuggestionLoading","suggestionText","keySuggestion","tooManySuggestionText","tooManyKeysSuggestion","enteredTextLabel","enteredKeyLabel","onRequest","onBlur","initialOptionsRef","valueHeader","optional","role","margin","top","undoPrompt","onClick","elem","undoButton","valueSuggestionOptions","valuePlaceholder","valuesSuggestionError","valuesSuggestionLoading","valueSuggestion","tooManyValuesSuggestion","enteredValueLabel","filteringKey","className","root","__internalRootRef","type","baseProps","__assign","items","addButtonText","addButton","removeButtonText","removeButton","disableAddButton","empty","emptyTags","additionalInfo","tagLimitExceeded","tagLimitReached"],"sourceRoot":"","sources":["../../../src/tag-editor/index.tsx"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport React, { useCallback, useImperativeHandle, useLayoutEffect, useMemo, useRef } from 'react';\nimport clsx from 'clsx';\n\nimport { getBaseProps } from '../internal/base-component';\nimport { fireNonCancelableEvent, NonCancelableCustomEvent } from '../internal/events';\nimport { useStableEventHandler } from '../internal/hooks/use-stable-event-handler';\n\nimport { InputProps } from '../input/interfaces';\nimport { AutosuggestProps } from '../autosuggest/interfaces';\nimport { AttributeEditorProps } from '../attribute-editor/interfaces';\nimport InternalAttributeEditor from '../attribute-editor/internal';\nimport InternalStatusIndicator from '../status-indicator/internal';\nimport InternalBox from '../box/internal';\nimport { FormFieldError } from '../form-field/internal';\n\nimport { TagControl, UndoButton } from './internal';\nimport { TagEditorProps } from './interfaces';\nimport { validate, ValidationError } from './validation';\nimport { findIndex, useMemoizedArray } from './utils';\n\nimport styles from './styles.css.js';\nimport { applyDisplayName } from '../internal/utils/apply-display-name';\nimport useBaseComponent from '../internal/hooks/use-base-component';\n\nexport { TagEditorProps };\n\ninterface InternalTag {\n  tag: TagEditorProps.Tag;\n  error?: ValidationError;\n}\n\nconst isItemRemovable = ({ tag }: InternalTag) => !tag.markedForRemoval;\n\nconst TagEditor = React.forwardRef(\n  (\n    {\n      tags = [],\n      i18nStrings,\n      loading = false,\n      tagLimit = 50,\n      allowedCharacterPattern,\n      keysRequest,\n      valuesRequest,\n      onChange,\n      ...restProps\n    }: TagEditorProps,\n    ref: React.Ref<TagEditorProps.Ref>\n  ) => {\n    const baseComponentProps = useBaseComponent('TagEditor');\n\n    const remainingTags = tagLimit - tags.filter(tag => !tag.markedForRemoval).length;\n\n    const attributeEditorRef = useRef<AttributeEditorProps.Ref>(null);\n    const keyInputRefs = useRef<(InputProps.Ref | undefined | null)[]>([]);\n    const valueInputRefs = useRef<(InputProps.Ref | undefined | null)[]>([]);\n    const undoButtonRefs = useRef<(HTMLAnchorElement | undefined | null)[]>([]);\n\n    const initialKeyOptionsRef = useRef<AutosuggestProps.Options>([]);\n    const keyDirtyStateRef = useRef<boolean[]>([]);\n    const focusEventRef = useRef<() => void>();\n\n    useLayoutEffect(() => {\n      focusEventRef.current?.apply(undefined);\n      focusEventRef.current = undefined;\n    });\n\n    const errors = validate(\n      tags,\n      keyDirtyStateRef.current,\n      i18nStrings,\n      allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined\n    );\n\n    const internalTags = useMemoizedArray(\n      tags.map((tag, i) => ({ tag, error: errors[i] })),\n      (prev, next) => {\n        return prev.tag === next.tag && prev.error?.key === next.error?.key && prev.error?.value === next.error?.value;\n      }\n    );\n\n    useImperativeHandle(\n      ref,\n      () => ({\n        focus() {\n          const errorIndex = findIndex(internalTags, ({ error }) => error?.key || error?.value);\n          if (errorIndex !== -1) {\n            const refArray = internalTags[errorIndex].error?.key ? keyInputRefs : valueInputRefs;\n            refArray.current[errorIndex]?.focus();\n          }\n        },\n      }),\n      [internalTags]\n    );\n\n    const validateAndFire = useCallback(\n      (newTags: ReadonlyArray<TagEditorProps.Tag>) => {\n        fireNonCancelableEvent(onChange, {\n          tags: newTags,\n          valid: !validate(\n            newTags,\n            keyDirtyStateRef.current,\n            i18nStrings,\n            allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined\n          ).some(error => error),\n        });\n      },\n      [onChange, i18nStrings, allowedCharacterPattern]\n    );\n\n    const onAddButtonClick = () => {\n      validateAndFire([...tags, { key: '', value: '', existing: false }]);\n      focusEventRef.current = () => {\n        keyInputRefs.current[tags.length]?.focus();\n      };\n    };\n\n    const onRemoveButtonClick = useStableEventHandler(\n      ({ detail }: NonCancelableCustomEvent<AttributeEditorProps.RemoveButtonClickDetail>) => {\n        const existing = tags[detail.itemIndex].existing;\n        validateAndFire([\n          ...tags.slice(0, detail.itemIndex),\n          ...(existing ? [{ ...tags[detail.itemIndex], markedForRemoval: true }] : []),\n          ...tags.slice(detail.itemIndex + 1),\n        ]);\n        if (existing) {\n          focusEventRef.current = () => {\n            undoButtonRefs.current[detail.itemIndex]?.focus();\n          };\n        } else {\n          keyDirtyStateRef.current.splice(detail.itemIndex, 1);\n          keyInputRefs.current[detail.itemIndex]?.focus();\n        }\n      }\n    );\n\n    const onKeyChange = useStableEventHandler((value: string, row: number) => {\n      keyDirtyStateRef.current[row] = true;\n      validateAndFire([...tags.slice(0, row), { ...tags[row], key: value }, ...tags.slice(row + 1)]);\n    });\n\n    const onKeyBlur = useStableEventHandler((row: number) => {\n      keyDirtyStateRef.current[row] = true;\n      // Force re-render by providing a new array reference\n      validateAndFire([...tags]);\n    });\n\n    const onValueChange = useStableEventHandler((value: string, row: number) => {\n      validateAndFire([...tags.slice(0, row), { ...tags[row], value }, ...tags.slice(row + 1)]);\n    });\n\n    const onUndoRemoval = useStableEventHandler((row: number) => {\n      validateAndFire([...tags.slice(0, row), { ...tags[row], markedForRemoval: false }, ...tags.slice(row + 1)]);\n      focusEventRef.current = () => {\n        attributeEditorRef.current?.focusRemoveButton(row);\n      };\n    });\n\n    const definition = useMemo(\n      () => [\n        {\n          label: i18nStrings.keyHeader,\n          control: ({ tag }: InternalTag, row: number) => (\n            <TagControl\n              row={row}\n              value={tag.key}\n              readOnly={tag.existing}\n              limit={200}\n              defaultOptions={[]}\n              placeholder={i18nStrings.keyPlaceholder}\n              errorText={i18nStrings.keysSuggestionError}\n              loadingText={i18nStrings.keysSuggestionLoading}\n              suggestionText={i18nStrings.keySuggestion}\n              tooManySuggestionText={i18nStrings.tooManyKeysSuggestion}\n              enteredTextLabel={i18nStrings.enteredKeyLabel}\n              onRequest={keysRequest}\n              onChange={onKeyChange}\n              onBlur={onKeyBlur}\n              initialOptionsRef={initialKeyOptionsRef}\n              ref={ref => {\n                keyInputRefs.current[row] = ref;\n              }}\n            />\n          ),\n          errorText: ({ error }: InternalTag) => error?.key,\n        },\n        {\n          label: (\n            <>\n              {i18nStrings.valueHeader} - <i>{i18nStrings.optional}</i>\n            </>\n          ),\n          control: ({ tag }: InternalTag, row: number) =>\n            tag.markedForRemoval ? (\n              <div role=\"alert\">\n                <InternalBox margin={{ top: 'xxs' }}>\n                  {i18nStrings.undoPrompt}{' '}\n                  <UndoButton\n                    onClick={() => onUndoRemoval(row)}\n                    ref={elem => {\n                      undoButtonRefs.current[row] = elem;\n                    }}\n                  >\n                    {i18nStrings.undoButton}\n                  </UndoButton>\n                </InternalBox>\n              </div>\n            ) : (\n              <TagControl\n                row={row}\n                value={tag.value}\n                readOnly={false}\n                limit={200}\n                defaultOptions={tag.valueSuggestionOptions ?? []}\n                placeholder={i18nStrings.valuePlaceholder}\n                errorText={i18nStrings.valuesSuggestionError}\n                loadingText={i18nStrings.valuesSuggestionLoading}\n                suggestionText={i18nStrings.valueSuggestion}\n                tooManySuggestionText={i18nStrings.tooManyValuesSuggestion}\n                enteredTextLabel={i18nStrings.enteredValueLabel}\n                filteringKey={tag.key}\n                onRequest={valuesRequest && (value => valuesRequest(tag.key, value))}\n                onChange={onValueChange}\n                ref={ref => {\n                  valueInputRefs.current[row] = ref;\n                }}\n              />\n            ),\n          errorText: ({ error }: InternalTag) => error?.value,\n        },\n      ],\n      [i18nStrings, keysRequest, onKeyChange, onKeyBlur, valuesRequest, onValueChange, onUndoRemoval]\n    );\n\n    if (loading) {\n      return (\n        <div className={styles.root} ref={baseComponentProps.__internalRootRef}>\n          <InternalStatusIndicator className={styles.loading} type=\"loading\">\n            {i18nStrings.loading}\n          </InternalStatusIndicator>\n        </div>\n      );\n    }\n\n    const baseProps = getBaseProps(restProps);\n    return (\n      <InternalAttributeEditor<InternalTag>\n        {...baseProps}\n        {...baseComponentProps}\n        ref={attributeEditorRef}\n        className={clsx(styles.root, baseProps.className)}\n        items={internalTags}\n        isItemRemovable={isItemRemovable}\n        onAddButtonClick={onAddButtonClick}\n        onRemoveButtonClick={onRemoveButtonClick}\n        addButtonText={i18nStrings.addButton}\n        removeButtonText={i18nStrings.removeButton}\n        disableAddButton={remainingTags <= 0}\n        empty={i18nStrings.emptyTags}\n        additionalInfo={\n          <div aria-live=\"polite\">\n            {remainingTags < 0 ? (\n              <FormFieldError>{i18nStrings.tagLimitExceeded(tagLimit) ?? ''}</FormFieldError>\n            ) : remainingTags === 0 ? (\n              i18nStrings.tagLimitReached(tagLimit) ?? ''\n            ) : (\n              i18nStrings.tagLimit(remainingTags, tagLimit)\n            )}\n          </div>\n        }\n        definition={definition}\n      />\n    );\n  }\n);\n\napplyDisplayName(TagEditor, 'TagEditor');\nexport default TagEditor;\n"]},"metadata":{},"sourceType":"module"}