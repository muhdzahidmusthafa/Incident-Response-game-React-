{"ast":null,"code":"// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport React, { useLayoutEffect, useMemo, useRef, useState } from 'react';\nimport clsx from 'clsx';\nimport { arc } from 'd3-shape';\nimport styles from './styles.css.js';\nimport { dimensionsBySize, balanceLabelNodes } from './utils';\nimport { useResizeObserver } from '../internal/hooks/container-queries';\nimport ResponsiveText from './responsive-text';\n\nfunction LabelElement(_a) {\n  var x = _a.x,\n      y = _a.y,\n      hideTitles = _a.hideTitles,\n      hideDescriptions = _a.hideDescriptions,\n      rightSide = _a.rightSide,\n      title = _a.title,\n      description = _a.description,\n      containerBoundaries = _a.containerBoundaries;\n  return (// Reset the transform property to prepare for `balanceLabelNodes`.\n    // The dataset attributes are also needed in the function for IE11 support.\n    React.createElement(\"g\", {\n      className: styles['label-text'],\n      transform: \"\",\n      \"data-x\": x,\n      \"data-y\": y\n    }, !hideTitles && React.createElement(ResponsiveText, {\n      x: x,\n      y: y,\n      rightSide: rightSide,\n      containerBoundaries: containerBoundaries\n    }, title), !hideDescriptions && description && React.createElement(ResponsiveText, {\n      x: x,\n      y: y + (hideTitles ? 0 : 18),\n      rightSide: rightSide,\n      className: styles.label__description,\n      containerBoundaries: containerBoundaries\n    }, description))\n  );\n}\n\nexport default (function (_a) {\n  var pieData = _a.pieData,\n      size = _a.size,\n      highlightedSegment = _a.highlightedSegment,\n      segmentDescription = _a.segmentDescription,\n      visibleDataSum = _a.visibleDataSum,\n      hideTitles = _a.hideTitles,\n      hideDescriptions = _a.hideDescriptions,\n      containerRef = _a.containerRef;\n  var containerBoundaries = useElementBoundaries(containerRef);\n  var markers = useMemo(function () {\n    var _a = dimensionsBySize[size],\n        radius = _a.outerRadius,\n        innerLabelPadding = _a.innerLabelPadding; // More arc factories for the label positioning\n\n    var arcMarkerStart = arc().innerRadius(radius - 1).outerRadius(radius - 1);\n    var arcMarkerBreak = arc().innerRadius(radius + innerLabelPadding).outerRadius(radius + innerLabelPadding);\n    return pieData.map(function (datum, i) {\n      var labelDatum = pieData[i];\n      var midAngle = labelDatum.startAngle + (labelDatum.endAngle - labelDatum.startAngle) / 2; // Make the marker line longer if the segment is closer to the top or bottom of the chart\n\n      arcMarkerBreak.outerRadius(radius + 20 * (0.5 * Math.cos(2 * midAngle) + 0.5));\n      arcMarkerBreak.innerRadius(radius + 20 * (0.5 * Math.cos(2 * midAngle) + 0.5));\n\n      var _a = arcMarkerStart.centroid(datum),\n          startX = _a[0],\n          startY = _a[1];\n\n      var _b = arcMarkerBreak.centroid(datum),\n          breakX = _b[0],\n          breakY = _b[1];\n\n      var rightSide = midAngle < Math.PI;\n      var endX = (radius + 20) * (rightSide ? 1 : -1);\n      var textX = endX + 5 * (rightSide ? 1 : -1);\n      return {\n        startX: startX,\n        startY: startY,\n        breakX: breakX,\n        breakY: breakY,\n        endX: endX,\n        endY: breakY,\n        textX: textX,\n        textY: breakY,\n        rightSide: rightSide,\n        datum: datum\n      };\n    });\n  }, [pieData, size]);\n  var rootRef = useRef(null);\n  useLayoutEffect(function () {\n    if (!rootRef.current) {\n      return;\n    } // Relax labels that are overlapping\n\n\n    var labelNodes = rootRef.current.querySelectorAll(\".\".concat(styles['label-text']));\n    balanceLabelNodes(labelNodes, markers, false);\n    balanceLabelNodes(labelNodes, markers, true);\n  }, [markers, pieData]);\n  return React.createElement(\"g\", {\n    className: styles.markers,\n    \"aria-hidden\": \"true\",\n    ref: rootRef\n  }, markers.map(function (_a) {\n    var _b;\n\n    var startX = _a.startX,\n        startY = _a.startY,\n        breakX = _a.breakX,\n        breakY = _a.breakY,\n        endX = _a.endX,\n        endY = _a.endY,\n        textX = _a.textX,\n        textY = _a.textY,\n        rightSide = _a.rightSide,\n        datum = _a.datum;\n    var segment = datum.data.datum;\n    var description = segmentDescription === null || segmentDescription === void 0 ? void 0 : segmentDescription(segment, visibleDataSum);\n\n    if (hideTitles && !description || hideDescriptions && !segment.title) {\n      return null;\n    }\n\n    return React.createElement(\"g\", {\n      key: datum.data.index,\n      className: clsx(styles.label, (_b = {}, _b[styles['label--highlighted']] = highlightedSegment === segment, _b[styles['label--dimmed']] = highlightedSegment !== null && highlightedSegment !== segment, _b[styles['label--align-right']] = !rightSide, _b))\n    }, React.createElement(\"line\", {\n      x1: startX,\n      y1: startY,\n      x2: breakX,\n      y2: breakY\n    }), React.createElement(\"line\", {\n      x1: breakX,\n      y1: breakY,\n      x2: endX,\n      y2: endY,\n      className: styles['label-line']\n    }), React.createElement(LabelElement, {\n      x: textX,\n      y: textY,\n      rightSide: rightSide,\n      title: segment.title,\n      description: description,\n      hideTitles: hideTitles,\n      hideDescriptions: hideDescriptions,\n      containerBoundaries: containerBoundaries\n    }));\n  }));\n});\n\nfunction useElementBoundaries(ref) {\n  var _a = useState({\n    left: 0,\n    right: 0\n  }),\n      state = _a[0],\n      setState = _a[1];\n\n  useResizeObserver(ref, function (entry) {\n    var elementRect = entry.target.getBoundingClientRect();\n    setState({\n      left: elementRect.left,\n      right: elementRect.right\n    });\n  });\n  return state;\n}","map":{"version":3,"mappings":"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","names":["React","useLayoutEffect","useMemo","useRef","useState","clsx","arc","styles","dimensionsBySize","balanceLabelNodes","useResizeObserver","ResponsiveText","LabelElement","_a","x","y","hideTitles","hideDescriptions","rightSide","title","description","containerBoundaries","className","transform","label__description","pieData","size","highlightedSegment","segmentDescription","visibleDataSum","containerRef","useElementBoundaries","markers","radius","innerLabelPadding","arcMarkerStart","innerRadius","outerRadius","arcMarkerBreak","map","datum","i","labelDatum","midAngle","startAngle","endAngle","Math","cos","centroid","startX","startY","breakX","breakY","PI","endX","textX","endY","textY","rootRef","current","labelNodes","querySelectorAll","ref","segment","data","key","index","label","_b","x1","y1","x2","y2","left","right","state","setState","elementRect","entry","target","getBoundingClientRect"],"sourceRoot":"","sources":["../../../src/pie-chart/labels.tsx"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport React, { useLayoutEffect, useMemo, useRef, useState } from 'react';\nimport clsx from 'clsx';\nimport { arc, PieArcDatum } from 'd3-shape';\n\nimport { PieChartProps } from './interfaces';\nimport styles from './styles.css.js';\nimport { InternalChartDatum } from './pie-chart';\nimport { dimensionsBySize, balanceLabelNodes } from './utils';\nimport { useResizeObserver } from '../internal/hooks/container-queries';\nimport ResponsiveText from './responsive-text';\n\nexport interface LabelsProps<T> {\n  pieData: PieArcDatum<InternalChartDatum<T>>[];\n  visibleDataSum: number;\n  size: NonNullable<PieChartProps['size']>;\n  hideTitles: boolean;\n  hideDescriptions: boolean;\n  highlightedSegment: PieChartProps.Datum | null;\n  segmentDescription?: PieChartProps.SegmentDescriptionFunction<T>;\n  containerRef: React.RefObject<HTMLDivElement>;\n}\n\ninterface LabelElementProps {\n  x: number;\n  y: number;\n  rightSide: boolean;\n  hideTitles: boolean;\n  hideDescriptions: boolean;\n  title: PieChartProps.Datum['title'];\n  description?: string;\n  containerBoundaries: null | { left: number; right: number };\n}\n\nfunction LabelElement({\n  x,\n  y,\n  hideTitles,\n  hideDescriptions,\n  rightSide,\n  title,\n  description,\n  containerBoundaries,\n}: LabelElementProps) {\n  return (\n    // Reset the transform property to prepare for `balanceLabelNodes`.\n    // The dataset attributes are also needed in the function for IE11 support.\n    <g className={styles['label-text']} transform=\"\" data-x={x} data-y={y}>\n      {!hideTitles && (\n        <ResponsiveText x={x} y={y} rightSide={rightSide} containerBoundaries={containerBoundaries}>\n          {title}\n        </ResponsiveText>\n      )}\n      {!hideDescriptions && description && (\n        <ResponsiveText\n          x={x}\n          y={y + (hideTitles ? 0 : 18)}\n          rightSide={rightSide}\n          className={styles.label__description}\n          containerBoundaries={containerBoundaries}\n        >\n          {description}\n        </ResponsiveText>\n      )}\n    </g>\n  );\n}\n\nexport default <T extends PieChartProps.Datum>({\n  pieData,\n  size,\n  highlightedSegment,\n  segmentDescription,\n  visibleDataSum,\n  hideTitles,\n  hideDescriptions,\n  containerRef,\n}: LabelsProps<T>) => {\n  const containerBoundaries = useElementBoundaries(containerRef);\n\n  const markers = useMemo(() => {\n    const { outerRadius: radius, innerLabelPadding } = dimensionsBySize[size];\n\n    // More arc factories for the label positioning\n    const arcMarkerStart = arc<PieArcDatum<any>>()\n      .innerRadius(radius - 1)\n      .outerRadius(radius - 1);\n\n    const arcMarkerBreak = arc<PieArcDatum<any>>()\n      .innerRadius(radius + innerLabelPadding)\n      .outerRadius(radius + innerLabelPadding);\n\n    return pieData.map((datum, i) => {\n      const labelDatum = pieData[i];\n      const midAngle = labelDatum.startAngle + (labelDatum.endAngle - labelDatum.startAngle) / 2;\n\n      // Make the marker line longer if the segment is closer to the top or bottom of the chart\n      arcMarkerBreak.outerRadius(radius + 20 * (0.5 * Math.cos(2 * midAngle) + 0.5));\n      arcMarkerBreak.innerRadius(radius + 20 * (0.5 * Math.cos(2 * midAngle) + 0.5));\n      const [startX, startY] = arcMarkerStart.centroid(datum);\n      const [breakX, breakY] = arcMarkerBreak.centroid(datum);\n\n      const rightSide = midAngle < Math.PI;\n      const endX = (radius + 20) * (rightSide ? 1 : -1);\n      const textX = endX + 5 * (rightSide ? 1 : -1);\n\n      return {\n        startX,\n        startY,\n        breakX,\n        breakY,\n        endX,\n        endY: breakY,\n        textX,\n        textY: breakY,\n        rightSide,\n        datum,\n      };\n    });\n  }, [pieData, size]);\n\n  const rootRef = useRef<SVGGElement>(null);\n\n  useLayoutEffect(() => {\n    if (!rootRef.current) {\n      return;\n    }\n\n    // Relax labels that are overlapping\n    const labelNodes = rootRef.current.querySelectorAll<SVGGElement>(`.${styles['label-text']}`);\n    balanceLabelNodes(labelNodes, markers, false);\n    balanceLabelNodes(labelNodes, markers, true);\n  }, [markers, pieData]);\n\n  return (\n    <g className={styles.markers} aria-hidden=\"true\" ref={rootRef}>\n      {markers.map(({ startX, startY, breakX, breakY, endX, endY, textX, textY, rightSide, datum }) => {\n        const segment = datum.data.datum;\n        const description = segmentDescription?.(segment, visibleDataSum);\n        if ((hideTitles && !description) || (hideDescriptions && !segment.title)) {\n          return null;\n        }\n        return (\n          <g\n            key={datum.data.index}\n            className={clsx(styles.label, {\n              [styles['label--highlighted']]: highlightedSegment === segment,\n              [styles['label--dimmed']]: highlightedSegment !== null && highlightedSegment !== segment,\n              [styles['label--align-right']]: !rightSide,\n            })}\n          >\n            <line x1={startX} y1={startY} x2={breakX} y2={breakY} />\n            <line x1={breakX} y1={breakY} x2={endX} y2={endY} className={styles['label-line']} />\n            <LabelElement\n              x={textX}\n              y={textY}\n              rightSide={rightSide}\n              title={segment.title}\n              description={description}\n              hideTitles={hideTitles}\n              hideDescriptions={hideDescriptions}\n              containerBoundaries={containerBoundaries}\n            />\n          </g>\n        );\n      })}\n    </g>\n  );\n};\n\nfunction useElementBoundaries(ref: React.RefObject<HTMLElement>): { left: number; right: number } {\n  const [state, setState] = useState({ left: 0, right: 0 });\n  useResizeObserver(ref, entry => {\n    const elementRect = entry.target.getBoundingClientRect();\n    setState({ left: elementRect.left, right: elementRect.right });\n  });\n  return state;\n}\n"]},"metadata":{},"sourceType":"module"}